/**
 * @overview:搜索旺旺
 *
 * @author: hpapple.hep
 * @date: 2012-02-01
*/
!(function($){
	
	var defaultConfig = {
		end:0
	};
		
	function Alitalk(id,cfg) {
		this.init(id,cfg);
	}
	
	$.extend(Alitalk.prototype,{
			init:function(root,cfg){
				this.config = $.extend(false, {}, defaultConfig, cfg);				
				this.iPageConfig = this.config.global ? this.config.global : window.iPageConfig;
					
				this.triggers = $('a[alitalk]',root);
				if(this.triggers.length == 0){
					return ;
				}				
				this._bindEvent(this.triggers);
			},
			_bindEvent:function(elements){
				var self = this;
				FE.util.alitalk(elements,{
					remote:false,
					prop: function () {
					
						var data =  $(this).data('alitalk');

						var isOnline = data.isOnline || '';
						var id = data.id;
						var type = data.type.toLowerCase();
						var memberLevel = data.memberLevel || '';				
						var infoId = data.infoId;
						var pos = data.pos;
						var p4pKeywords = data.p4pKeywords;	
						
						var toId = id;
						var offerId = infoId;
						var source = 1;	
						
						var d = new Date();							

						// 打点1
						if (document.images) {
						  (new Image()).src = "http://page.1688.com/others/offeralitalkclick.htm?online="+ isOnline +"&type="+ type +"list&member="+ memberLevel +"&time="+ d.getTime();
						}	

						// 打点 2 ：登陆后 询盘
						var fromId = Qingguo.Utility.getMemberId();
						
						if(fromId != ''){
							var params = [];
							params.push('?fromId='+fromId);
							params.push('toId=' + toId);
							params.push('offerId=' + offerId);
							params.push('source=' + source);
							params.push('cna=' + (Qingguo.Utility.getCookie('cna') || ''));
							
							var offerUrl = '';
							if(offerId && offerId != ''){
								offerUrl = 'http://detail.1688.com/buyer/offerdetail/' + offerId + '.html';
							}
							params.push('sourceUrl=' + offerUrl);

							if(typeof window.dmtrack != "undefined"){
								dmtrack.clickstat("http://interface.xp.1688.com/eq/enquiry/traceEnquiry.json",params.join('&'));
							}else{
								if(document.images) {
									(new Image()).src="http://interface.xp.1688.com/eq/enquiry/traceEnquiry.json" + params.join('&') + "&time=" + d.getTime();
								}
							}
						}	

						// 打点3
						var clickURL = 'http://stat.1688.com/feedback/click.html?';
							var sourcetype = 'searchsell';	
						var cosite = '';
						try{ 
							cosite = document.cookie.match(/track_cookie[^;]*cosite=(\w+)/)[1]; 
							if(! cosite){
								cosite = '';
							}
						}catch(e){}
						
						clickURL = clickURL + 'type=alitalk&sourcetype='+'&memberLevel='+ memberLevel +'&toid=' + toId + "&fromsite=" + cosite;
						if (document.images) {
							(new Image()).src = clickURL + "&time=" + d.getTime();
						}					
						
						// 传参
						var str = '';
						var url1 = "&url1=http://amis1.sh1.china.alibaba.com/potentialContact.dll?";
					
						if(infoId && infoId.length > 0){
							str += '&gid=' + infoId + url1 + 'offerId=' + infoId;
						}
						str += '&info_id=' + infoId;
						
						if(pos && pos!=''){
							var p4pstr = 'p4p_offerid=' + infoId + '#p4p_pageid=' + Qingguo.Utility.getSearchPageId()+ '#p4p_keywords=' + escape(p4pKeywords) + '#p4p_pos=' + pos + '#p4p_pid=819010_1008';
							str += p4pstr;
						}
						return str;
					
					}
				});
			},
			_delayBindEvent:function(root, nodes){
				
				var moreElements = $('a[alitalk]',root);
				Qingguo.Utility.uniqueMerge(moreElements, nodes);
				if(moreElements.length == 0){
					return ;
				}
				this._bindEvent(moreElements);
			},
			end:0
	});
	
	Qingguo.Business.Alitalk = Alitalk;
})(jQuery);

!(function($){
	
	var Sandbox,
		self,
		configs = {
			end:0
		};
	
	function MaindataAlitalk(sb) {
		Sandbox = sb;
		return MaindataAlitalk;
	}
	
	$.extend(MaindataAlitalk,{
			init:function(cfg){
				self=this;
				self.config = $.extend(false, {}, configs, cfg);
				
				self.root = $('#sw_mod_searchlist');
				
				//offer搜索40条减为20条优化需求
				if(self.root.length>0){
					var oAlitalk = new Qingguo.Business.Alitalk(self.root,cfg);
					var alitalkMain = $('a[alitalk]',self.root);
					
					Sandbox.on([Qingguo.Config.Events.BigRender, Qingguo.Config.Events.OfferAsyncOffer], 
						function(data){
							oAlitalk._delayBindEvent(self.root, alitalkMain);
							alitalkMain = $('a[alitalk]',self.root);
						}
					);
				}
			},
			end:0
	});
	
	Qingguo.Business.MaindataAlitalk = MaindataAlitalk;
	AppCore.register("sw_mod_maindataAlitalk", Qingguo.Business.MaindataAlitalk);
		
})(jQuery);

