/**
 * 底部热门推荐
 * @author dongming.jidm
 * date:2012-12-17
 */
!(function($){
	
	var Sandbox,
		configs = {
			"p4pRequest": "http://match.p4p.1688.com/b2bad?keyword=",
			"bottomAd": "#bottom_ad",
			end:0
		},self;
	
	function HotRecommend(sb) {
		Sandbox = sb;
		return HotRecommend;
	}
	
	$.extend(HotRecommend,{
				
			init:function(){

				this.config = $.extend(true, {}, configs);
				
				self = this;

				self.__getData();
			},

			__getData: function() {
	            if(typeof p4pObject === "undefined"){
	                return;
	            }

	            if(typeof(dmtrack_pageid) != "undefined"){
	                pageid = dmtrack_pageid;
	            } else {
	                pageid = "";
	            }

	            var dataObj = {
	                catid: "",
	                dcatid: p4pObject.dcatid,
	                pid: p4pObject.pid,
	                pageid: pageid,
	                outfmt: "json",
	                count: 6,
	                t: new Date().getTime()
	            };

	            var keywords = p4pObject.keyword;

	            self.__sendARequest(self.config.p4pRequest + keywords,dataObj,self.__getDataSuccessCallback,self.__getDataFailCallback);

	        },

	        __getDataSuccessCallback: function( data ) {
	            self.__renderData( data );
	        },

	        __getDataFailCallback: function() {

	        },

	        __renderData: function( data ) {
	            if( data.length < 1 ) {
	                return ;
	            }

	            var templateHtml = "";
	            // var dadianName = "";
	            // var outData = {};
	            // if( typeof pageconfig !== "undefined" ) {
	            //     dadianName = pageconfig.pinYinName;
	            //     outData.dadianName = dadianName;
	            // }

	            templateHtml = '<% for ( var i = 0; i < $data.length; i++ ) { %>\
									<% if (i === $data.length) { %>\
										<li class="last">\
									<% }else{ %>\
										<li>\
									<% } %>\
						    				<dl>\
						    					<dt class="verticalImg">\
						    						<a href="<%= $data[i].eurl %>" class="boxImg" target="_blank"><img src="<%= $data[i].offerimgurl.replace("summ","220x220") %>" alt="<%= $data[i].title %>"></a>\
						    					</dt>\
						    					<dd class="description">\
						    						<a href="<%= $data[i].eurl %>" target="_blank" title="<%= $data[i].title %>"><%= $data[i].title %></a>\
						    					</dd>\
						    					<dd class="price">\
													<span class="fd-cny">￥</span>\
													<span class="value"><%= Number($data[i].price).toFixed(2) %></span>\
													<span class="unit">/<%= $data[i].priceunit %></span>\
												</dd>\
												<dd class="company" title="<%= $data[i].company %>"><%= $data[i].company %></dd>\
						    				</dl>\
					    				</li>\
				    			<% } %>';

	            $.use('web-sweet',function(){
	                var htmlp4poffer = FE.util.sweet(templateHtml).applyData(data);
	                $("ul.offerList",self.config.bottomAd).html(htmlp4poffer);
	            });
	        },

	        __sendARequest: function(url,dataObj,successCallback,failCallback) {
	            $.ajax(url, {
	                data: dataObj || {} ,
	                dataType: 'jsonp',
	                success: function(data){
	                    // console.log(data)
	                 if(data.resultset.status !== "ok"){
	                    if(typeof failCallback !== "undefined"){
	                      failCallback();
	                    }else{
	                      return ;
	                    }
	                  }else{
	                    successCallback(data.resultset.docset);
	                  }
	                },
	                error: function(){
	                  if(typeof failCallback !== "undefined"){
	                    failCallback();
	                  }else{
	                    return ;
	                  }
	                }
	          });
	        },
					
			end:0
	});
	
	Qingguo.Business.HotRecommend = HotRecommend;
	
	
	AppCore.lazyRegister("qingguo_mod_hotrecommend", "Qingguo.Business.HotRecommend", "#bottom_ad", 'exposure');	
				
})(jQuery);