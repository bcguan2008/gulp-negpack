/**
 * 行业广告
 * @author dongming.jidm
 * date:2013-01-23
 */
!(function($){
	
	var Sandbox,
		configs = {
			"requestUrl": "http://ye.1688.com/industrybelt/recommend/get_seo_recommond.jsonp?_input_charset=utf-8",
			"caigouRequestUrl": "http://www.1688.com/chanpin/rpc/getBuyOffers.jsonp?_input_charset=utf-8",
			"leftAd": "#industry_left_ad",
			"bottomAd": "#industry_bottom_ad",
            "caigouAd": "#caigou_ad",
			end:0
		},self;
	
	function IndustryOffer(sb) {
		Sandbox = sb;
		return IndustryOffer;
	}
	
	$.extend(IndustryOffer,{
				
			init:function(){

				this.config = $.extend(true, {}, configs);
				
				self = this;

				self.__getData();

				//self.__getCaigouData();
				self.__sidebarFollow();
			},

			__getData: function() {
	            if(typeof iPageConfig === "undefined"){
	                return;
	            }

	            var keywords = iPageConfig.keywords;
				var industryId = iPageConfig.fengxiangbiaoCategoryId;

	            var dataObj = {
	                "keywords": keywords,
	                "industryId": industryId
	            };

	            self.__sendARequest(self.config.requestUrl, dataObj,self.__getDataSuccessCallback,self.__getDataFailCallback);

	        },

	        __getDataSuccessCallback: function( data ) {
	            self.__renderData( data );
	        },

	        __getDataFailCallback: function() {

	        },

	        __renderData: function( data ) {
	            if( data.length < 1 ) {
	                return ;
	            }

	            if( typeof data.recIndustryBelt !== 'undefined' && data.recIndustryBelt.length === 0 ) {
	            	$(self.config.leftAd).hide();
	            }

	            if( typeof data.bottomOffer !== 'undefined' && data.bottomOffer.length === 0 ) {
	            	$(self.config.bottomAd).hide();
	            }

	            var leftAdHtml = "", bottomAdHtml = "";

	            leftAdTemplate = '<% for ( var i = 0; i < ($data.recIndustryBelt.length >= 3 ? 3 : $data.recIndustryBelt.length); i++ ) { %>\
								<div class="verticalImg">\
				 					<a href="<%= $data.recIndustryBelt[i].linkUrl %>" class="boxImg" target="_blank" trace="w_sale_leftbanner">\
										<img style="width: 150px;height: 150px;" src="<%= $data.recIndustryBelt[i].imgUrl %>">\
									</a>\
				 				</div>\
				    			<% } %>';

	            bottomAdTemplate = '<% for ( var i = 0; i < ($data.bottomOffer.length >= 6 ? 6 : $data.bottomOffer.length); i++ ) { %>\
									<% if (i === $data.bottomOffer.length || i === 5) { %>\
										<li class="last">\
									<% }else{ %>\
										<li>\
									<% } %>\
						    				<dl>\
						    					<dt class="verticalImg">\
						    						<a href="<%= $data.bottomOffer[i].linkUrl %>" class="boxImg" target="_blank" trace="w_sale_leftbanner"><img src="<%= $data.bottomOffer[i].imgUrl.replace("summ","220x220") %>" alt="<%= $data.bottomOffer[i].title %>"></a>\
						    					</dt>\
						    					<dd class="description">\
						    						<a href="<%= $data.bottomOffer[i].linkUrl %>" target="_blank" title="<%= $data.bottomOffer[i].title %>" trace="w_sale_leftbanner"><%= $data.bottomOffer[i].title %></a>\
						    					</dd>\
						    				</dl>\
					    				</li>\
				    			<% } %>';

	            $.use('web-sweet',function(){
	                var leftAdHtml = FE.util.sweet(leftAdTemplate).applyData(data),
	                	bottomAdHtml = FE.util.sweet(bottomAdTemplate).applyData(data);

	                $(self.config.leftAd).append(leftAdHtml);
	                $("ul.offerList",self.config.bottomAd).html(bottomAdHtml);
	            });
	        },

            __getCaigouData: function() {

                if(typeof iPageConfig === "undefined"){
                    return;
                }

                var keywords = iPageConfig.keywords;

                var dataObj = {
                    "keywords": keywords
                };

                self.__sendARequest(self.config.caigouRequestUrl, dataObj,self.__getCaigouDataSuccess,self.__getCaigouDataFail);

				self.__sidebarFollow();

            },
			
			__sidebarFollow: function(){
				(new SidebarFollow()).init({
                    element: $(self.config.caigouAd),
                    distanceToTop: 0
                });
			},

            __getCaigouDataSuccess: function( data ) {
                self.__renderCaigouAd(data);
            },

            __getCaigouDataFail: function() {
                return;
            },

            __renderCaigouAd: function( data ) {
                if( !data.notEmpty ) {
                    $('div.sub', self.config.caigouAd).hide();
                    $('div.more', self.config.caigouAd).hide();
                    return;
                }

                var html = '<p class="title">“<em><%= $data.title %></em>”的相关询价</p>\
                <ul class="list">\
                    <% for ( var i = 0; i < $data.adItems.length; i++ ) { %>\
                        <li>\
                            <div class="item fd-clr">\
                                <div class="icon"></div>\
                                <a href="<%= $data.adItems[i].url %>" target="_blank"><%= $data.adItems[i].description %></a>\
                            </div>\
                            <div class="info fd-clr">\
                                <span class="prefix">收到报价</span>\
                                <span class="count"><%= $data.adItems[i].quoteCount %></span>\
                            </div>\
                        </li>\
                    \<% } %>\
                </ul>';

                $.use('web-sweet',function(){
                    var buyHtml = FE.util.sweet(html).applyData(data);

                    $('div.sub', self.config.caigouAd).html(buyHtml);

                    $('div.more', self.config.caigouAd).show();
                });
            },

	        __sendARequest: function(url,dataObj,successCallback,failCallback) {
	            $.ajax(url, {
	                data: dataObj || {} ,
	                dataType: 'jsonp',
	                success: function(data){
	                    // console.log(data)
	                 if( data.hasError ){
	                    if(typeof failCallback !== "undefined"){
	                      failCallback();
	                    }else{
	                      return ;
	                    }
	                  }else{
	                    successCallback(data.content);
	                  }
	                },
	                error: function(){
	                  if(typeof failCallback !== "undefined"){
	                    failCallback();
	                  }else{
	                    return ;
	                  }
	                }
	          });
	        },
					
			end:0
	});
	
	Qingguo.Business.IndustryOffer = IndustryOffer;
	
	AppCore.register("qingguo_mod_industryAd", Qingguo.Business.IndustryOffer);
				
})(jQuery);