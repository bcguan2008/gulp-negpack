/**
 * 搜索高级筛选区js
 
 * @author terence.wangt
 * date:2012.03.12
 */
!(function($){
	
	var Sandbox,
		SU = Qingguo.Utility,
		configs = {
			'formid':'#frmFiltSearch',
			'submit':'#J_submitBtn',
			'id': 'sw_mod_filter',
			end:0
		};
	
	function Filter(sb) {
		Sandbox = sb;
		return Filter;
	}
	
	$.extend(Filter,{
				
			init:function(cfg){

				this.config = $.extend(true, {}, configs);
				this.filter = $("#"+this.config.id);
				this.form 	= $(this.config.formid);
				
				this.inputFilter();
			},
					

			inputFilter:function(){
				
				/*下拉菜单初始化*/
				this.init_filter_select();
								
				/*复选框初始化*/
				this.init_checkbox();
				
				/*橱窗模式初始化*/
				this.init_ShowStyle();
				
				/*起订量筛选*/
				this.quantityFilter();
				
				/*价格筛选*/
				this.priceInit();
				
				/*价格排序*/
				this.priceSortInit();
				
				/*销量排序*/
				this.countSortInit();	

				/*库存量筛选*/
				this.storageFilter();

				/*提交前disable隐藏域中的空值*/
				this.disableEmptyInput();	
				
				/*促销checkbox*/
				this.promotionCheckbox();				
			},
			
			
			/*下拉菜单相关的事件及功能*/
			init_filter_select:function(){
				var select_arr=['#filter_bizetype','#filter_employeeCount','#filter_annualRevenue','#filter_Cxbz','#filter_membership', '#filter_annualRevenue', '#filter_employeeCount'];
				
				for(var i=0,len=select_arr.length;i<len;i++){
					var select = select_arr[i];
					this.filter.find(select).bind('mouseover',function(ev){
						ev.preventDefault();
						ev.stopPropagation();
						$(this).find('.Select-item').show();
						
					});
					this.filter.find(select).bind('mouseout',function(ev){
						ev.preventDefault();
						ev.stopPropagation();
						$(this).find('.Select-item').hide();
					});				
				}

				var self = this;	
				this.filter.find('ul.Select-item li a').bind('click', function(e){
				
					e.preventDefault();
					
					var ul = $(this).parents('ul:first');
					var li = $(this).parents('li:first')
					var field = $(ul).attr('_frmfield');

					ul.hide();
					if($(li).hasClass('selected'))
						return;
					
					var value   = $(this).attr('val');
					var descend = $(this).attr('descendOrder');

					self.form.find('input[name='+field+']').val(value);
					
					//特殊处理
					if(field=='sortType'){
						self.form.find('input[name=sortType]').val(value);
						self.form.find('input[name=descendOrder]').val(descend);
					}
					
					if(field=='creditBalance'){
						self.form.find('input[name=isCreditFlag]').val('true');
					}
					
					$("#"+field+'Label').html($(this).html());
					$(self.config.submit).click();
				}); 
			},
			
			init_checkbox:function(){

				var ckb_arr=['#filter_ckbWholesale', '#filter_ckbAlipay', '#filter_ckbSurence', '#J_ckbWangWang','#filter_ckbmixWholesale','#filter_ckbWholesaleEvenOne','#filter_ckbnewProduct','#filter_ckbtags','#filter_ckbmembertags', '#filter_ckbmultipleSize','#filter_ckbmultipleColor','#filter_ckbQingcang','#filter_ckbMergeSuply','#filter_ckbMergeSameDesign'];
				
				var self = this;
				for(var i=0; i< ckb_arr.length; i++){
					
					var checkbox = ckb_arr[i];
					self.filter.find(checkbox).bind('click', function(){
					
						var field = $(this).attr('_frmfield');					
						switch(this.id){
							case 'J_ckbWangWang':
							self.form.find('input[name='+field+']').val(this.checked ? 'yes' : 'all');
							break;
							case 'filter_ckbMergeSuply':
							self.form.find('input[name='+field+']').val(this.checked ? 'userid' : '');
							self.form.find('input[name=filter_ckbMergeSameDesign]').val('');
							break;
							case 'filter_ckbMergeSameDesign':
							self.form.find('input[name='+field+']').val(this.checked ? 'pic_tag_id' : '');
							self.form.find('input[name=filter_ckbMergeSuply]').val('');
							break;
							case 'filter_ckbtags':							
							self.form.find('input[name='+field+']').val(this.checked ?  $(this).attr('_fiedvalue') : '');
							break;
							case 'filter_ckbmembertags':							
							self.form.find('input[name='+field+']').val(this.checked ?  $(this).attr('_fiedvalue') : '');
							break;
							default:
							self.form.find('input[name='+field+']').val(this.checked ? true : false);
						}					
						
						//小额批发下默认使用橱窗模式
						if(this.id == "filter_ckbWholesale"){
							self.form.find('input[name=showStyle]').val('shopwindow');
						}
						//小额批发下默认使用橱窗模式
						if(this.id == "filter_ckbSurence" && !this.checked){
							self.form.find('input[name=creditBalance]').val('');
						}
						$(self.config.submit).click();
					});
				}
			},
			
			init_ShowStyle:function(){
				
				var self = this;
				
				$('.sw-ui-tab').find('div.mode a').bind('click', function(e){
					e.preventDefault();				
					if($(this).hasClass('selected-img') || $(this).hasClass('selected-noimg')|| $(this).hasClass('selected-window'))
						return;
						
					var field = $(this).parents('.mode').attr('_frmfield');
					$(self.config.formid).find('input[name='+field+']').val($(this).attr('val'));
					$(self.config.submit).click();
				});
			},
			
			/**
			 * 起订量筛选及相关事件
			 * @method quantityFilter
			 */
			quantityFilter:function(){
				var self = this;
				var priceFormTime = null;
				var reg = /^[1-9]+\d*$/,tmp = '';
				function fun3() {
					if (this.value) {
						if (reg.test(this.value)) {
							tmp = this.value;
						} else
							this.value = tmp;
					} else tmp = '';
				}
				this.filter.find('#frmQuantityBegin').bind('keyup blur', fun3);
				
				this.filter.find('#frmQuantityBegin').bind('focus',function(){
					clearTimeout(priceFormTime);
					var parentNodeEl = $(this).parents('li:first');
					parentNodeEl.addClass('price-selected');
				});
				
				this.filter.find('#frmQuantityBegin').bind('blur',function(){
					var parentNodeEl = $(this).parents('li:first');
					priceFormTime = setTimeout(function(){
						parentNodeEl.removeClass('price-selected');
					},300);
				});
				
				var self = this;
				this.filter.find('#quantityBeginBtn').bind('click', function(){
					var tracelog = $(this).attr('default');
					
					var quanlity = ($('#frmQuantityBegin').val() !='') ? 'q' : '';
					
					var price = ($('#frmPriceStart').val()!=''|| $('#frmPriceEnd').val() !='')? 's' : '';
					var traceValue = price + quanlity;
					
					tracelog=tracelog.replace(/defaultBegin/,traceValue);
					SU.aliclick(this, "?searchtrace=" +tracelog);
					
					self._setInputValue('#frmQuantityBegin', '');
					$(self.config.submit).click();
				});	
			},

			/**
			 * 库存量筛选（破茧项目中增加）
			 */
			storageFilter: function() {
				var self = this;
				var priceFormTime = null;
				var reg = /^[1-9]+\d*$/,tmp = '';
				function fun3() {
					if (this.value) {
						if (reg.test(this.value)) {
							tmp = this.value;
						} else
							this.value = tmp;
					} else tmp = '';
				}
				this.filter.find('#frmStorage').bind('keyup blur', fun3);
				
				this.filter.find('#frmStorage').bind('focus',function(){
					clearTimeout(priceFormTime);
					var parentNodeEl = $(this).parents('li:first');
					parentNodeEl.addClass('price-selected');
				});
				
				this.filter.find('#frmStorage').bind('blur',function(){
					var parentNodeEl = $(this).parents('li:first');
					priceFormTime = setTimeout(function(){
						parentNodeEl.removeClass('price-selected');
					},300);
				});
				
				var self = this;
				this.filter.find('#storageBtn').bind('click', function(){
					var tracelog = $(this).attr('default');
					// 打点，先放一下
					// var quanlity = ($('#frmQuantityBegin').val() !='') ? 'q' : '';
					
					// var price = ($('#frmPriceStart').val()!=''|| $('#frmPriceEnd').val() !='')? 's' : '';
					// var traceValue = price + quanlity;
					
					// tracelog=tracelog.replace(/defaultBegin/,traceValue);
					// SU.aliclick(this, "?searchtrace=" +tracelog);
					
					self._setInputValue('#frmStorage', '');
					$(self.config.submit).click();
				});	
			},
			
			
			/**
			 * 价格筛选及相关事件
			 * @method priceInit
			 */
			priceInit:function(){
				var priceFormTime = null;
				var reg = /^\d*(\.\d*)?$/,temp1 = temp2 = "";
				function fun1() {
					if (this.value) {
						if (reg.test(this.value)) {
							temp1 = this.value;
						} else
							this.value = temp1;
					} else temp1 = '';

				}
				function fun2() {
					if (this.value) {
						if (reg.test(this.value)) {
							temp2 = this.value;
						} else
							this.value = temp2;
					} else temp2 = '';
				}
				/*初价格筛选*/

				this.filter.find('#frmPriceStart').bind('focus',function(){
					clearTimeout(priceFormTime);
					this.select();
					var parentNodeEl = $(this).parents('div:first');
					parentNodeEl.addClass('price-selected');
					
					if($("#frmPriceEnd").val() == '最高价'){
						$("#frmPriceEnd").val('');
					}
				});
				
				this.filter.find('#frmPriceStart').bind('blur',function(){
					if($("#frmPriceEnd").val() == ''){
						$("#frmPriceEnd").val('最高价');
					}
				});
				this.filter.find('#frmPriceEnd').bind('blur',function(){
					if($("#frmPriceStart").val() == ''){
						$("#frmPriceStart").val('最低价');
					}
				});
				
				/*末价格筛选*/
				this.filter.find('#frmPriceEnd').bind('focus',function(){
					this.select();
					clearTimeout(priceFormTime);
					var parentNodeEl = $(this).parents('div:first');
					parentNodeEl.addClass('price-selected');
					if($("#frmPriceStart").val() == '最低价'){
						$("#frmPriceStart").val('');
					}
				});
				
				this.filter.find('#frmPriceStart').bind('keyup',fun1);
				this.filter.find('#frmPriceStart').bind('blur', function() {
					fun1.call(this);
					if (this.value && reg.test(this.value)) {
						temp1 = this.value = (('0' + this.value) * 1).toFixed(2);
					}
					var parentNodeEl = $(this).parents('div:first');
					priceFormTime = setTimeout(function(){
						parentNodeEl.removeClass('price-selected');
					},300);
				});

				this.filter.find('#frmPriceEnd').bind('keyup',fun2);
				this.filter.find('#frmPriceEnd').bind('blur', function() {
					fun2.call(this);
					if (this.value && reg.test(this.value)){
						temp2 = this.value = (('0' + this.value) * 1).toFixed(2);
					}
					var parentNodeEl = $(this).parents('div:first');
					priceFormTime = setTimeout(function(){
						parentNodeEl.removeClass('price-selected');
					},300);
				});
				
				var self = this;
				this.filter.find('#priceRangeBtn').bind('click', function() {

					var tracelog = $(this).attr('default');
					var quanlity = $('#frmQuantityBegin').val()!='' ? 'q' : '';
					var price = ($('#frmPriceStart').val() !=''|| $('#frmPriceEnd').val()!='')? 's' : '';
					var traceValue = price + quanlity;
					tracelog=tracelog.replace(/defaultRange/,traceValue);
					SU.aliclick(this, "?searchtrace=" +tracelog);
									
					self._setInputValue('#frmPriceStart', '最低价');
					self._setInputValue('#frmPriceEnd', '最高价');
					
					$(self.config.submit).click();
				});

				this.inputTextInit('#frmPriceStart');	
				this.inputTextInit('#frmPriceEnd');			
			},
			
			_setInputValue:function(id, defaultValue){
				
				var currentValue = $(id).val();
				
				var field = $(id).attr('_frmfield');
				
				if(currentValue.trim() == defaultValue){
					this.form.find('input[name='+field+']').val('');
				}
				else{
					this.form.find('input[name='+field+']').val(currentValue);
				}
			},
			
			priceSortInit:function(){
			
				var self = this;

				$('#filter_pricesortasc,#filter_pricesortdesc').bind('click', function(e){
					
					e.preventDefault();
					var sortType = $(this).attr('val');
					var descendOrder = $(this).attr('descendOrder');
					var priceStart = self.form.find('input[name=priceStart]');
					if(descendOrder === 'false' && priceStart.val() ===''){
						priceStart.val(1);
					}
					if(descendOrder === '' && priceStart.val() ==='1.0'){
						priceStart.val('');
					}					
					self.form.find('input[name=sortType]').val(sortType);
					self.form.find('input[name=descendOrder]').val(descendOrder);
					
					$(self.config.submit).click();
				});
			},
			
			countSortInit:function(){
			
				var self = this;
				this.filter.find('#filter_countsort').bind('click', function(e){
					
					e.preventDefault();
					var sortType = $(this).attr('val');
					var descendOrder = $(this).attr('descendOrder');
					
					self.form.find('input[name=sortType]').val(sortType);
					self.form.find('input[name=descendOrder]').val(descendOrder);
					/*需要做个buckettest测试，但需要排除掉点了按销量排序的流量，所以暂时添加这个参数，后期可以去除。*/
					self.form.find('input[name=clickSaleSort]').val('true');
					$(self.config.submit).click();
				});
			},
			
			
			inputTextInit:function(id){
			
				var self = this;
				var els = $(id);
				if(els.val() == ''){
					els.val(els.attr('_default'));
				}else if(els.val() && els.val()!=els.attr('_default')){
					els.addClass('blur');
				}
				
				els.bind('focus',function(){
					if($(this).val() == $(this).attr('_default')){
						$(this).val('');
					}
					$(this).addClass('blur');
				});
				els.bind('blur',function(){
					if($(this).val() == $(this).attr('_default')||$.trim($(this).val())==''){
						$(this).val($(this).attr('_default'));
						$(this).removeClass('blur');
					}
				});
			},
			
			/*提交前disable隐藏域中的空值*/
			disableEmptyInput:function(){

				var self = this;
				$(self.config.submit).bind('click', function(){self.disableInput();});
			},
			
			disableInput:function(){

				$('input[type=hidden]', this.config.formid).each(function(index, input) {
					if($(input).val() === ""){
						$(input).attr('disabled', 'disabled');
					}
				});
			},
			promotionCheckbox:function(){
				var trigger = $('#filter_ckbpromotion');
				if(trigger.length === 0){
					return ;
				}
				var url = $('+ a',trigger).attr('href');
				
				trigger.on('click',function(){
					location.href = url; 
					
				});
			},
			end:0
	});
	
	Qingguo.Business.Filter = Filter;
	AppCore.register("qingguo_mod_filter", Qingguo.Business.Filter);
		
})(jQuery);