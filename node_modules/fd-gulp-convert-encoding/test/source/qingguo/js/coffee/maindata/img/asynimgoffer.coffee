###
 The last 20 offers in maindata area asyn load
 AsynOfferImgChild extends from base class AsynOffer
 @author dongming.jidm
 @date 2012-12-26
###

(($) ->
	self = null
	requestURL = "http://china.alibaba.com/chanpin/rpc/query.jsonp?_input_charset=utf-8"
	Sandbox = null;
	defConfig = 
		url: requestURL
		showStyle: "img"

	AsynImgOffer = ( sb ) ->
		Sandbox = sb
		return AsynImgOffer

	$.extend AsynImgOffer, {
		init: ->
			self = this
			
			class AsynOfferImgChild extends Qingguo.Business.AsynOffer
				constructor: -> super(defConfig)

				renderData: ( data ) => 
					self.renderHtml(data)
					return

			asynOffer = new AsynOfferImgChild(defConfig)
			asynOffer.run()
			return

		renderHtml: ( data ) ->
			if data.length < 1
				return 0
			templateHtml = '''
			<% for ( var i = 0; i < $data.length; i++ ) { %>
			<li class="fd-clr">
				<div class="productPic verticalImg">
					<a href="<%= $data[i].detailUrl %>" class="boxImg" t="w_sale_offer_img">
						<img data-lazyload-src="<%= $data[i].imgUrl.replace("summ","220x220") %>" alt="<%= $data[i].simpleSubject %>">
					</a>
				</div>
				<h2 class="title ms-yh">
					<a href="<%= $data[i].detailUrl %>" title="<%= $data[i].simpleSubject %>" target="_blank" t="w_sale_offer_title"><%= $data[i].subject %></a>
				</h2>
				<div class="leftDes">
					<p class="attribute">
						<% for ( var j = 0; j < $data[i].briefList.length; j++ ) { %>
							<% if (j === $data[i].briefList.length - 1) { %>
								<span class="last">
							<% }else{ %>
								<span>
							<% } %><%= $data[i].briefList[j].name %>:<%= $data[i].briefList[j].value4Asyn %></span>
						<% } %>
					</p>
					<p class="category">
						<% if(typeof $data[i].categoryList !== "undefined" && $data[i].categoryList != null) { %>
							<span>类目：</span>
							<% for ( var m = 0; m < $data[i].categoryList.length; m++ ) { %>
								<a href="<%= $data[i].categoryList[m].url %>" t="w_sale_cat"><%= $data[i].categoryList[m].name %></a>
							<% } %>
						<% } %>
	 				</p>
					<p class="relatedProduct">
						<% if(typeof $data[i].relateWordList !== "undefined" && $data[i].relateWordList != null) { %>
							<span>相关产品：</span>
							<% for ( var k = 0; k < $data[i].relateWordList.length; k++ ) { %>
								<a href="<%= $data[i].relateWordList[k].url %>" t="w_sale_related"><%= $data[i].relateWordList[k].word %></a>
							<% } %>
						<% } %>
					</p>
					<p class="dealMount">
						<% if($data[i].showBookedCount) { %>
							<span>成交<%= $data[i].bookedCount %>笔</span>
							<span>
								<a target="_blank" href="<%= $data[i].evaluateUrl %>" t="w_sale_pj" rel="nofollow"><%= $data[i].evaluateCounts %>条评价</a>
							</span>
						<% } %>
					</p>
					<p class="viewPrice">
						<a href="<%= $data[i].detailUrl %>" target="_blank" t="w_sale_price">查看价格详情</a>
					</p>
				</div>
				<div class="rightDes">
					<% if( typeof $data[i].company !== 'undefined') { %>
					<h3 class="companyName"><a href="<%= $data[i].company.memberUrl %>" target="_blank" t="w_sale_cn"><%= $data[i].company.companyName %></a></h3>
					<p class="companyAdress">[<%= $data[i].provinceDesc %> <%= $data[i].cityDesc %>]</p>
					<p class="jingyingMod"><span>经营模式：</span><%= $data[i].company.parentTypeName %></p>
					<p class="mainMange">
						<span>主营：</span>
						<% for ( var q = 0; q < $data[i].company.productionWords.length; q++ ) { %>
							<a href="<%= $data[i].company.offerListUrl %>" t="w_sale_service" rel="nofollow"><%= $data[i].company.productionWords[q].abbrBusiness %></a>
						<% } %>
					</p>
					<p class="chengxintong">
						<% if(typeof $data[i].trustCreditUrl !== "undefined" && $data[i].trustCreditUrl != null) { %>
							<a rel="nofollow" class="sw-ui-icon-cxt16x16" trace="w_sale_cxt" href="<%= $data[i].trustCreditUrl %>" target="_blank" title="阿里巴巴建议您优先选择诚信通会员">
								第<span class="CreditYear"><%= $data[i].tpServiceYear %></span>年
				    		</a>
						<% } %>
					</p>
					<% } %>
				</div>
			</li>
			<% } %>
			'''

			$.use 'web-sweet', () ->
				offers = FE.util.sweet(templateHtml).applyData(data)
				$("ul.qg-offerresults","#content").append(offers)
				$("#offers_asyn").remove()
				return

			return
	}

	Qingguo.Business.AsynImgOffer = AsynImgOffer;

	AppCore.lazyRegister "qingguo_mod_asynimgoffer", "Qingguo.Business.AsynImgOffer", "#offers_asyn", "exposure"
	return
) jQuery



