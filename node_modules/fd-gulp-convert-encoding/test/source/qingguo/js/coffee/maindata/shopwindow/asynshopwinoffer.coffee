###
 The last 20 offers in maindata area asyn load
 AsynOfferShopwindowChild extends from base class AsynOffer
 @author dongming.jidm
 @date 2012-12-26
###

(($) ->
	self = null
	requestURL = "http://china.alibaba.com/chanpin/rpc/queryWindow.jsonp?_input_charset=utf-8"

	defConfig = 
		url: requestURL
		showStyle: "shopwindow"

	AsynShopWindowOffer = () ->
		return AsynShopWindowOffer

	$.extend AsynShopWindowOffer, {
		init: ->
			self = this
			
			class AsynOfferShopwindowChild extends Qingguo.Business.AsynOffer
				constructor: -> super(defConfig)

				renderData: ( data ) => 
					self.renderHtml(data)
					return

			asynOffer = new AsynOfferShopwindowChild(defConfig)
			asynOffer.run()
			return

		renderHtml: ( data ) ->
			if data.length < 1
				return 0

			templateHtml = '''
			<% for ( var i = 0; i < $data.length; i++ ) { %>
			<li>
				<dl>
					<dt class="verticalImg">
						<a href="<%= $data[i].detailUrl %>" class="boxImg" target="_blank" t="w_sale_s_offer_img"><img data-lazyload-src="<%= $data[i].imgUrl %>" alt="<%= $data[i].simpleSubject %>"></a>
					</dt>
					<dd class="description ms-yh">
						<a href="<%= $data[i].detailUrl %>" target="_blank" title="<%= $data[i].simpleSubject %>" t="w_sale_s_offer_title"><%= $data[i].subject %></a>
					</dd>
					<dd class="dealMount">
						<% if($data[i].showBookedCount) { %>
							<span>成交<%= $data[i].bookedCount %>笔</span>
							<span>
								<a target="_blank" href="<%= $data[i].evaluateUrl %>" t="w_sale_pj"><%= $data[i].evaluateCounts %>条评价</a>
							</span>
						<% } %>
					</dd>
					<dd class="relatedProduct">
						<span>相关产品：</span>
						<% if(typeof $data[i].relateWordList !== "undefined" && $data[i].relateWordList != null) { %>
							<% for ( var k = 0; k < $data[i].relateWordList.length; k++ ) { %>
								<a href="<%= $data[i].relateWordList[k].url %>" t="w_sale_s_related"><%= $data[i].relateWordList[k].word %></a>
							<% } %>
						<% } %>
					</dd>
					<dd class="company">
						<% if(typeof $data[i].trustCreditUrl !== "undefined" && $data[i].trustCreditUrl != null) { %>
							<a rel="nofollow" href="<%= $data[i].trustCreditUrl %>" t="w_sale_s_cxt" class="sw-ui-icon-cxt16x16" target="_blank" title="诚信通·企业会员"></a>
						<% } %>
						<a href="<%= $data[i].memberUrl %>" target="_blank" t="w_sale_s_cn" title="<%= $data[i].companyName %>" class="companyName"><%= $data[i].companyName %></a>
					</dd>
					<dd class="price">
						<a href="<%= $data[i].detailUrl %>" target="_blank" t="w_sale_s_price">查看价格详情</a>
					</dd>
				</dl>
			</li>
			<% } %>
			'''

			$.use 'web-sweet', () ->
				offers = FE.util.sweet(templateHtml).applyData(data)
				$("ul.qg-offerresults-shopwindow","#content").append(offers)
				$("#offers_asyn").remove()
				return

			return
	}

	Qingguo.Business.AsynShopWindowOffer = AsynShopWindowOffer;

	AppCore.lazyRegister "qingguo_mod_asynshopwindowoffer", "Qingguo.Business.AsynShopWindowOffer", "#offers_asyn", "exposure"
	return
) jQuery



